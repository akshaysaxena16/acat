name: stepfunctions-cicd

on:
  pull_request:
    paths:
      - "stepfunctions/**"
      - "scripts/**"
      - ".github/workflows/stepfunctions-cicd.yml"
  push:
    branches: ["main"]
    paths:
      - "stepfunctions/**"
      - "scripts/**"
      - ".github/workflows/stepfunctions-cicd.yml"
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate manifest + definitions are valid JSON
        shell: bash
        run: |
          set -euo pipefail
          jq -e . stepfunctions/manifest.json >/dev/null
          for f in stepfunctions/definitions/*.asl.json; do
            jq -e . "$f" >/dev/null
          done
          for f in stepfunctions/env/*.json; do
            jq -e . "$f" >/dev/null
          done

      - name: Smoke render all definitions (cert)
        shell: bash
        run: |
          set -euo pipefail
          for f in stepfunctions/definitions/*.asl.json; do
            out="$(mktemp)"
            python3 scripts/render_asl.py stepfunctions/env/cert.json "$f" "$out"
            jq -e . "$out" >/dev/null
            rm -f "$out"
          done

  deploy-cert:
    if: github.event_name == 'push'
    needs: [validate]
    runs-on: ubuntu-latest
    environment: cert
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (cert)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_CERT }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Detect changed step function definitions
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          CHANGED="$(scripts/detect_changed_stepfunctions.sh "$BASE_SHA" "$HEAD_SHA" | sed '/^\s*$/d' || true)"

          echo "Changed definitions:"
          echo "$CHANGED"

          {
            echo "changed<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Deploy changed workflows to cert
        if: ${{ steps.changes.outputs.changed != '' }}
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SFN_EXECUTION_ROLE_ARN: ${{ secrets.SFN_EXECUTION_ROLE_ARN_CERT }}
          SFN_LOG_GROUP_ARN: ${{ secrets.SFN_LOG_GROUP_ARN_CERT }}
          ENV_NAME: cert
        run: |
          set -euo pipefail
          chmod +x scripts/deploy_sfn.sh scripts/detect_changed_stepfunctions.sh
          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            scripts/deploy_sfn.sh "$ENV_NAME" "$f"
          done <<< "${{ steps.changes.outputs.changed }}"

  deploy-prod-auto:
    # Prod is gated by GitHub Environment approvals (configure in repo settings).
    if: github.event_name == 'push'
    needs: [validate, deploy-cert]
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Determine definitions to deploy to prod
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
          CHANGED="$(scripts/detect_changed_stepfunctions.sh "$BASE_SHA" "$HEAD_SHA" | sed '/^\s*$/d' || true)"

          echo "Definitions:"
          echo "$CHANGED"

          {
            echo "changed<<EOF"
            echo "$CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Deploy to prod
        if: ${{ steps.changes.outputs.changed != '' }}
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SFN_EXECUTION_ROLE_ARN: ${{ secrets.SFN_EXECUTION_ROLE_ARN_PROD }}
          SFN_LOG_GROUP_ARN: ${{ secrets.SFN_LOG_GROUP_ARN_PROD }}
          ENV_NAME: prod
        run: |
          set -euo pipefail
          chmod +x scripts/deploy_sfn.sh scripts/detect_changed_stepfunctions.sh
          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            scripts/deploy_sfn.sh "$ENV_NAME" "$f"
          done <<< "${{ steps.changes.outputs.changed }}"

  deploy-prod-manual:
    # Manual prod deploy (deploys all definitions).
    if: github.event_name == 'workflow_dispatch'
    needs: [validate]
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy all definitions to prod
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SFN_EXECUTION_ROLE_ARN: ${{ secrets.SFN_EXECUTION_ROLE_ARN_PROD }}
          SFN_LOG_GROUP_ARN: ${{ secrets.SFN_LOG_GROUP_ARN_PROD }}
          ENV_NAME: prod
        run: |
          set -euo pipefail
          chmod +x scripts/deploy_sfn.sh
          for f in stepfunctions/definitions/*.asl.json; do
            scripts/deploy_sfn.sh "$ENV_NAME" "$f"
          done

