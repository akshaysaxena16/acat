name: stepfunctions-cicd

on:
  pull_request:
    paths:
      - "stepfunctions/**"
      - "scripts/**"
      - ".github/workflows/stepfunctions-cicd.yml"
  push:
    branches: ["cert", "prod"]
    paths:
      - "stepfunctions/**"
      - "scripts/**"
      - ".github/workflows/stepfunctions-cicd.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - cert
          - prod
      mode:
        description: "Deploy mode"
        required: true
        type: choice
        options:
          - changed
          - all

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate manifest + definitions are valid JSON
        shell: bash
        run: |
          set -euo pipefail
          jq -e . stepfunctions/manifest.json >/dev/null
          for f in stepfunctions/definitions/*.asl.json; do
            jq -e . "$f" >/dev/null
          done
          for f in stepfunctions/env/*.json; do
            jq -e . "$f" >/dev/null
          done

      - name: Smoke render all definitions (cert)
        shell: bash
        run: |
          set -euo pipefail
          for f in stepfunctions/definitions/*.asl.json; do
            out="$(mktemp)"
            python3 scripts/render_asl.py stepfunctions/env/cert.json "$f" "$out"
            jq -e . "$out" >/dev/null
            rm -f "$out"
          done

  deploy-cert:
    if: |
      (github.event_name == 'push' && github.ref_name == 'cert') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'cert')
    needs: [validate]
    runs-on: ubuntu-latest
    environment: cert
    concurrency:
      group: stepfunctions-cert
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (cert)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_CERT }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Determine deploy + delete changes (cert)
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.mode }}" == "all" ]]; then
            DEPLOY_LIST="$(git ls-files 'stepfunctions/definitions/*.asl.json')"
            DELETE_LIST=""
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            RAW="$(scripts/detect_stepfunctions_changes.sh "$BASE_SHA" "$HEAD_SHA" || true)"
            DEPLOY_LIST="$(echo "$RAW" | awk -F: '$1=="DEPLOY"{print $2}' | sed '/^\s*$/d' || true)"
            DELETE_LIST="$(echo "$RAW" | awk -F: '$1=="DELETE"{print $2}' | sed '/^\s*$/d' || true)"
          fi

          echo "Deploy definitions:"
          echo "$DEPLOY_LIST"
          echo
          echo "Delete workflow ids:"
          echo "$DELETE_LIST"

          {
            echo "deploy<<EOF"
            echo "$DEPLOY_LIST"
            echo "EOF"
            echo "delete<<EOF"
            echo "$DELETE_LIST"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Deploy changed workflows to cert
        if: ${{ steps.changes.outputs.deploy != '' }}
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SFN_EXECUTION_ROLE_ARN: ${{ secrets.SFN_EXECUTION_ROLE_ARN_CERT }}
          SFN_LOG_GROUP_ARN: ${{ secrets.SFN_LOG_GROUP_ARN_CERT }}
          ENV_NAME: cert
        run: |
          set -euo pipefail
          chmod +x scripts/deploy_sfn.sh scripts/detect_stepfunctions_changes.sh
          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            scripts/deploy_sfn.sh "$ENV_NAME" "$f"
          done <<< "${{ steps.changes.outputs.deploy }}"

      - name: Delete removed workflows in cert
        if: ${{ steps.changes.outputs.delete != '' }}
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ENV_NAME: cert
        run: |
          set -euo pipefail
          chmod +x scripts/delete_sfn.sh
          while IFS= read -r id; do
            [[ -z "$id" ]] && continue
            scripts/delete_sfn.sh "$ENV_NAME" "$id"
          done <<< "${{ steps.changes.outputs.delete }}"

  deploy-prod:
    # Prod is gated by GitHub Environment approvals (configure in repo settings).
    if: |
      (github.event_name == 'push' && github.ref_name == 'prod') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'prod')
    needs: [validate]
    runs-on: ubuntu-latest
    environment: prod
    concurrency:
      group: stepfunctions-prod
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (prod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Determine deploy + delete changes (prod)
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.mode }}" == "all" ]]; then
            DEPLOY_LIST="$(git ls-files 'stepfunctions/definitions/*.asl.json')"
            DELETE_LIST=""
          else
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
            RAW="$(scripts/detect_stepfunctions_changes.sh "$BASE_SHA" "$HEAD_SHA" || true)"
            DEPLOY_LIST="$(echo "$RAW" | awk -F: '$1=="DEPLOY"{print $2}' | sed '/^\s*$/d' || true)"
            DELETE_LIST="$(echo "$RAW" | awk -F: '$1=="DELETE"{print $2}' | sed '/^\s*$/d' || true)"
          fi

          echo "Deploy definitions:"
          echo "$DEPLOY_LIST"
          echo
          echo "Delete workflow ids:"
          echo "$DELETE_LIST"

          {
            echo "deploy<<EOF"
            echo "$DEPLOY_LIST"
            echo "EOF"
            echo "delete<<EOF"
            echo "$DELETE_LIST"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Deploy to prod
        if: ${{ steps.changes.outputs.deploy != '' }}
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SFN_EXECUTION_ROLE_ARN: ${{ secrets.SFN_EXECUTION_ROLE_ARN_PROD }}
          SFN_LOG_GROUP_ARN: ${{ secrets.SFN_LOG_GROUP_ARN_PROD }}
          ENV_NAME: prod
        run: |
          set -euo pipefail
          chmod +x scripts/deploy_sfn.sh scripts/detect_stepfunctions_changes.sh
          while IFS= read -r f; do
            [[ -z "$f" ]] && continue
            scripts/deploy_sfn.sh "$ENV_NAME" "$f"
          done <<< "${{ steps.changes.outputs.deploy }}"

      - name: Delete removed workflows in prod
        if: ${{ steps.changes.outputs.delete != '' }}
        shell: bash
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          ENV_NAME: prod
        run: |
          set -euo pipefail
          chmod +x scripts/delete_sfn.sh
          while IFS= read -r id; do
            [[ -z "$id" ]] && continue
            scripts/delete_sfn.sh "$ENV_NAME" "$id"
          done <<< "${{ steps.changes.outputs.delete }}"

